<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .diagnosis-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    .diagnosis-card:hover {
        transform: translateY(-5px);
    }
    .diagnosis-card img {
        max-width: 300px;
        width: 100%;
        height: auto;
        border-radius: 5px;
        margin: 10px 0;
    }
    .table-container {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-top: 20px;
    }
    .table th, .table td {
        vertical-align: middle;
    }
    .table img {
        max-width: 100px;
        height: auto;
        border-radius: 5px;
    }
    .btn-toggle {
        margin-bottom: 20px;
    }
    .btn-primary {
        background: linear-gradient(45deg, #007bff, #00b7eb);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(45deg, #0056b3, #0098c7);
    }
    .btn-danger {
        background: linear-gradient(45deg, #dc3545, #e4606d);
        border: none;
    }
    .btn-danger:hover {
        background: linear-gradient(45deg, #b02a37, #c14c5a);
    }
    .text-orange {
        color: #f08c38;
    }
    .text-orange:hover {
        color: #d8762d;
    }
    .no-diagnoses {
        text-align: center;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 10px;
    }
</style>

{% extends 'base.html' %}

{% block title %}Patient Dashboard - MediScanIQ{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h2 class="text-primary mb-4">Welcome, {{ user.fname }} {{ user.lname }}</h2>
    <h3 class="mb-3">Your Diagnoses</h3>

    <!-- Toggle Button -->
    {% if diagnoses %}
        <button class="btn btn-primary btn-toggle" id="toggleView">Switch to Table View</button>
    {% endif %}

    <!-- Card View -->
    <div id="cardView" class="view">
        {% if diagnoses %}
            {% for diagnosis in diagnoses %}
                <div class="diagnosis-card">
                    <h3>{{ diagnosis.diagnosis }} ({{ (diagnosis.confidence * 100)|round(2) }}%)</h3>
                    <p><strong>Description:</strong> {{ diagnosis.description|truncate(200) }}</p>
                    <p><strong>Treatment:</strong> {{ diagnosis.treatment|truncate(200) }}</p>
                    <p><strong>Medicines:</strong> {{ diagnosis.medicines|truncate(200) }}</p>
                    <p><img src="{{ diagnosis.xray_image|default('/static/default_xray.png') }}" alt="X-ray Image"></p>
                    <p><img src="{{ diagnosis.heatmap|default('/static/default_heatmap.png') }}" alt="Heatmap"></p>
                    <a href="{{ url_for('result', id=diagnosis.id) }}" class="btn btn-primary">View Details</a>
                    {% if editable %}
                        <a href="{{ url_for('edit_diagnosis', id=diagnosis.id) }}" class="btn btn-outline-primary mt-2">Edit</a>
                        <button class="btn btn-danger mt-2 delete-btn" data-id="{{ diagnosis.id }}" data-url="{{ url_for('delete_result', id=diagnosis.id) }}">Delete</button>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="no-diagnoses">
                <p class="text-muted">
                    No diagnoses available. <a href="{{ url_for('upload') }}" class="text-orange">Upload an X-ray</a> to get started.
                </p>
            </div>
        {% endif %}
    </div>

    <!-- Table View -->
    <div id="tableView" class="view" style="display: none;">
        {% if diagnoses %}
            <div class="table-container">
                <table id="diagnosesTable" class="table table-striped table-bordered">
                    <thead class="bg-primary text-white">
                        <tr>
                            <th>Diagnosis</th>
                            <th>Confidence</th>
                            <th>Description</th>
                            <th>Treatment</th>
                            <th>Medicines</th>
                            <th>X-ray</th>
                            <th>Heatmap</th>
                            {% if editable %}
                                <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for diagnosis in diagnoses %}
                            <tr>
                                <td>{{ diagnosis.diagnosis }}</td>
                                <td>{{ (diagnosis.confidence * 100)|round(2) }}%</td>
                                <td>{{ diagnosis.description|truncate(100) }}</td>
                                <td>{{ diagnosis.treatment|truncate(100) }}</td>
                                <td>{{ diagnosis.medicines|truncate(100) }}</td>
                                <td><img src="{{ diagnosis.xray_image|default('/static/default_xray.png') }}" alt="X-ray"></td>
                                <td><img src="{{ diagnosis.heatmap|default('/static/default_heatmap.png') }}" alt="Heatmap"></td>
                                {% if editable %}
                                    <td>
                                        <a href="{{ url_for('result', id=diagnosis.id) }}" class="btn btn-primary btn-sm">View</a>
                                        <a href="{{ url_for('edit_diagnosis', id=diagnosis.id) }}" class="btn btn-outline-primary btn-sm">Edit</a>
                                        <button class="btn btn-danger btn-sm delete-btn" data-id="{{ diagnosis.id }}" data-url="{{ url_for('delete_result', id=diagnosis.id) }}">Delete</button>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>

    {% if editable %}
        <div class="mt-4 text-center">
            <a href="{{ url_for('upload') }}" class="btn btn-primary">Upload New X-ray</a>
            <a href="{{ url_for('profile') }}" class="btn btn-outline-primary">View Profile</a>
        </div>
    {% endif %}
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<script>
    $(document).ready(function() {
        // Initialize DataTable
        $('#diagnosesTable').DataTable({
            pageLength: 10,
            order: [[0, 'asc']],
            columnDefs: [
                { orderable: false, targets: -1 } // Disable sorting on Actions column
            ]
        });

        // Toggle between card and table views
        $('#toggleView').click(function() {
            const cardView = $('#cardView');
            const tableView = $('#tableView');
            if (cardView.is(':visible')) {
                cardView.hide();
                tableView.show();
                $(this).text('Switch to Card View');
            } else {
                tableView.hide();
                cardView.show();
                $(this).text('Switch to Table View');
            }
        });

        // Delete button confirmation
        $('.delete-btn').click(function() {
            if (confirm('Are you sure you want to delete this diagnosis?')) {
                const url = $(this).data('url');
                $.post(url, function() {
                    location.reload();
                }).fail(function() {
                    alert('Failed to delete diagnosis. Please try again.');
                });
            }
        });
    });
</script>
{% endblock %}